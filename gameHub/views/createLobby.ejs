<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
  <title>Create Lobby</title>
  <style>
    @keyframes kenburns {
      0% { transform: scale(1) translate(0, 0); opacity: 0; }
      10%, 90% { opacity: 1; }
      100% { transform: scale(1.1) translate(-3%, -3%); opacity: 0; }
    }

    .kenburns-image {
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      background-size: cover;
      background-position: center;
      animation: kenburns 30s ease-in-out infinite;
      opacity: 0;
      filter: brightness(1.3);
      z-index: 0;
    }

    .kenburns-image:nth-child(n) {
      animation-delay: calc((n - 1) * 3s);
    }

    #gameSearch {
      box-sizing: border-box;
      width: 100%;
    }

    #searchResults {
      box-sizing: border-box;
      width: 100%;
      max-height: 192px;
      overflow-y: auto;
      border: 1px solid #d1d5db;
      border-radius: 0.375rem;
      padding: 0.25rem 0;
      background-color: white;
      z-index: 50;
      position: absolute;
    }
  </style>
</head>

<body class="relative bg-gray-100 font-sans text-gray-800">
  <!-- Background -->
  <div id="kenburns-bg-wrapper" class="fixed inset-0 z-0 overflow-hidden"></div>
  <div class="fixed inset-0 bg-black/70 z-10 pointer-events-none"></div>

  <!-- Navigation -->
  <div class="relative z-20">
    <div class="flex flex-row justify-center pt-2 pb-2 text-md text-white space-x-5 bg-black">
      <button class="px-3" onclick="window.location.href='/home'">Home</button>
      <button class="px-3" onclick="window.location.href='/profile'">Profile</button>
      <button class="px-3" onclick="window.location.href='/help'">Help</button>
      <form class="px-3" action="/logout"><input type="submit" value="Logout" /></form>
    </div>
  </div>

  <!-- Create Lobby Form -->
  <div class="relative z-20 flex flex-row mx-auto justify-center max-w-3xl pt-5">
    <div class="justify-center bg-white shadow rounded-lg p-4 w-full">
      <form action="<%= (typeof gameId !== 'undefined' && gameId) ? '/createLobby/' + gameId : '/createLobby' %>" method="POST">
        <div class="flex flex-row justify-center">
          <h1 class="font-bold text-2xl pb-4">Create your lobby</h1>
        </div>

        <div class="relative mb-6">
          <!-- Game Search -->
          <label for="gameSearch" class="block mb-1 font-semibold">Search Game Name:</label>
          <input type="text" id="gameSearch" placeholder="Search for a co-op multiplayer game..."
            class="border border-gray-300 rounded-md px-2 py-1 w-full" autocomplete="off" />
          <ul id="searchResults" class="hidden mt-2 text-sm shadow-sm"></ul>
          <input type="hidden" id="gameName" name="gameName" />
        </div>

        <div class="space-y-4">
          <!-- Lobby Name -->
          <label for="lobbyName" class="block font-semibold">Lobby Name:</label>
          <input type="text" id="lobbyName" name="lobbyName" required
            class="border border-gray-300 rounded-md px-2 py-1 w-full" />

          <!-- Number of Players -->
          <label for="numPlayers" class="block font-semibold">Number of Players:</label>
          <input type="number" id="numPlayers" name="numPlayers" min="2" max="10" required
            class="border border-gray-300 rounded-md px-2 py-1 w-full" />

          <!-- Tags -->
          <label for="tags" class="block font-semibold">Game Tags <span class="text-gray-400 text-sm">(Ctrl or Cmd to select multiple)</span>:</label>
          <select id="tags" name="tags" multiple size="3"
            class="border border-gray-300 rounded-md px-2 py-1 w-full">
            <option value="coop">Co-op</option>
            <option value="competitive">Competitive</option>
            <option value="casual">Casual</option>
            <option value="ranked">Ranked</option>
            <option value="custom">Custom</option>
          </select>
        </div>

        <!-- Buttons -->
        <div class="flex flex-row justify-between mt-6">
          <button type="submit"
            class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded shadow-md transition hover:scale-[1.01] ease-in-out">
            Create Lobby
          </button>
          <button type="button" onclick="window.location.href='/yourActiveLobby'"
            class="bg-red-500 hover:bg-red-400 text-white px-4 py-2 rounded shadow-md transition hover:scale-[1.01] ease-in-out">
            Cancel Lobby
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- JavaScript -->
  <script>
    const apiKey = 'f61c15c68f3246a3aeebcfa53cdef84f';
    const searchInput = document.getElementById("gameSearch");
    const resultsList = document.getElementById("searchResults");
    const hiddenInput = document.getElementById("gameName");

    searchInput.addEventListener("input", async () => {
      const query = searchInput.value.trim();

      if (query.length < 2) {
        resultsList.innerHTML = "";
        resultsList.classList.add("hidden");
        return;
      }

      try {
        const res = await fetch(`https://api.rawg.io/api/games?key=${apiKey}&search=${query}&tags=multiplayer,co-op&page_size=10`);
        const data = await res.json();
        resultsList.innerHTML = "";

        if (data.results.length === 0) {
          resultsList.classList.add("hidden");
          return;
        }

        data.results.forEach((game) => {
          const li = document.createElement("li");
          li.textContent = game.name;
          li.className = "cursor-pointer hover:bg-gray-200 px-2 py-1";
          li.addEventListener("click", () => {
            searchInput.value = game.name;
            hiddenInput.value = game.name;
            resultsList.innerHTML = "";
            resultsList.classList.add("hidden");
          });
          resultsList.appendChild(li);
        });

        resultsList.classList.remove("hidden");
      } catch (err) {
        console.error("Error searching games:", err);
      }
    });

    document.addEventListener("click", (event) => {
      if (!resultsList.contains(event.target) && event.target !== searchInput) {
        resultsList.classList.add("hidden");
      }
    });

    // Ken Burns Background
    const wrapper = document.getElementById('kenburns-bg-wrapper');
    fetch(`https://api.rawg.io/api/games?key=${apiKey}&tags=multiplayer,co-op&page_size=10&page=5`)
      .then((res) => res.json())
      .then((data) => {
        data.results.forEach((game) => {
          if (game.background_image) {
            const bg = document.createElement('div');
            bg.className = 'kenburns-image';
            bg.style.backgroundImage = `url(${game.background_image})`;
            wrapper.appendChild(bg);
          }
        });
      });
  </script>

  <% if (typeof error !== 'undefined') { %>
    <script>alert("<%= error %>");</script>
  <% } %>
</body>
</html>
